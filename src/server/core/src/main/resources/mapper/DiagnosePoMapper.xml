<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//dtd/Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhenbanban.core.infrastructure.persistence.mapper.DiagnosePoMapper">
    <!-- 疾病诊断(diagnoses)表映射 -->

    <insert id="insert" parameterType="DiagnosePo" useGeneratedKeys="false">
        INSERT INTO diagnoses (id, icd_type, icd_code, icd_name, icd_name_pinyin, icd_name_pinyin_abbr,
                               icd_optional_name, icd_optional_name_pinyin, icd_optional_name_pinyin_abbr,
                               icd_alias_name, icd_alias_name_pinyin, icd_alias_name_pinyin_abbr, description,
                               chapter_code, chapter_name, block_code, block_name, created_at, updated_at, deleted_at)
        VALUES (#{id}, #{icdType}, #{icdCode}, #{icdName}, #{icdNamePinyin}, #{icdNamePinyinAbbr},
                #{icdOptionalName}, #{icdOptionalNamePinyin}, #{icdOptionalNamePinyinAbbr}, #{icdAliasName},
                #{icdAliasNamePinyin}, #{icdAliasNamePinyinAbbr}, #{description}, #{chapterCode}, #{chapterName},
                #{blockCode}, #{blockName}, #{createdAt}, #{updatedAt}, #{deletedAt})
    </insert>

    <update id="update" parameterType="DiagnosePo">
        UPDATE diagnoses
        SET icd_type                            = #{icdType},
            icd_code                            = #{icdCode},
            icd_name                            = #{icdName},
            icd_name_pinyin                     = #{icdNamePinyin},
            icd_name_pinyin_abbr                = #{icdNamePinyinAbbr},
            icd_optional_name                   = #{icdOptionalName},
            icd_optional_name_pinyin            = #{icdOptionalNamePinyin},
            icd_optional_name_pinyin_abbr       = #{icdOptionalNamePinyinAbbr},
            icd_alias_name                      = #{icdAliasName},
            icd_alias_name_pinyin               = #{icdAliasNamePinyin},
            icd_alias_name_pinyin_abbr          = #{icdAliasNamePinyinAbbr},
            description                         = #{description},
            chapter_code                        = #{chapterCode},
            chapter_name                        = #{chapterName},
            block_code                          = #{blockCode},
            block_name                          = #{blockName},
            updated_at                          = #{updatedAt}
        WHERE id = #{id}
    </update>

    <delete id="delete" parameterType="Long">
        DELETE
        FROM diagnoses
        WHERE id = #{id}
    </delete>

    <select id="findById" parameterType="Long" resultType="DiagnosePo">
        SELECT *
        FROM diagnoses
        WHERE id = #{id}
    </select>

    <select id="findIdByCodeAndName" resultType="Long">
        SELECT id
        FROM diagnoses
        WHERE icd_code = #{icdCode} AND icd_name = #{icdName}
    </select>

    <select id="findAll" resultType="DiagnosePo">
        SELECT *
        FROM diagnoses
    </select>

    <select id="count" parameterType="java.util.Map" resultType="long">
        SELECT COUNT(id) FROM diagnoses
        <where>
            <if test="icdType != null and icdType > 0">
                AND icd_type = #{icdType}
            </if>
            <if test="keywords != null and keywords.size() > 0">
                AND (
                <foreach item="w" collection="keywords" separator="OR">
                    icd_code LIKE CONCAT('%', #{w}, '%')
                    OR icd_name LIKE CONCAT('%', #{w}, '%')
                    OR icd_name_pinyin LIKE CONCAT('%', #{w}, '%')
                    OR icd_name_pinyin_abbr LIKE CONCAT('%', #{w}, '%')
                    OR icd_optional_name LIKE CONCAT('%', #{w}, '%')
                    OR icd_optional_name_pinyin LIKE CONCAT('%', #{w}, '%')
                    OR icd_optional_name_pinyin_abbr LIKE CONCAT('%', #{w}, '%')
                    OR icd_alias_name LIKE CONCAT('%', #{w}, '%')
                    OR icd_alias_name_pinyin LIKE CONCAT('%', #{w}, '%')
                    OR icd_alias_name_pinyin_abbr LIKE CONCAT('%', #{w}, '%')
                </foreach>
                )
            </if>
        </where>
    </select>

    <select id="search" parameterType="java.util.Map" resultType="DiagnosePo">
        SELECT * FROM diagnoses
        <where>
            <if test="icdType != null and icdType > 0">
                AND icd_type = #{icdType}
            </if>
            <if test="keywords != null and keywords.size() > 0">
                AND (
                <foreach item="w" collection="keywords" separator="OR">
                    icd_code LIKE CONCAT('%', #{w}, '%')
                    OR icd_name LIKE CONCAT('%', #{w}, '%')
                    OR icd_name_pinyin LIKE CONCAT('%', #{w}, '%')
                    OR icd_name_pinyin_abbr LIKE CONCAT('%', #{w}, '%')
                    OR icd_optional_name LIKE CONCAT('%', #{w}, '%')
                    OR icd_optional_name_pinyin LIKE CONCAT('%', #{w}, '%')
                    OR icd_optional_name_pinyin_abbr LIKE CONCAT('%', #{w}, '%')
                    OR icd_alias_name LIKE CONCAT('%', #{w}, '%')
                    OR icd_alias_name_pinyin LIKE CONCAT('%', #{w}, '%')
                    OR icd_alias_name_pinyin_abbr LIKE CONCAT('%', #{w}, '%')
                </foreach>
                )
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="orderBy != null and orderBy != ''">
                #{orderBy}
            </when>
            <otherwise>
                id DESC
            </otherwise>
        </choose>
        <if test="offset != null and limit != null">
            LIMIT #{offset}, #{limit}
        </if>
        <if test="offset == null and limit != null">
            LIMIT #{limit}
        </if>
        <if test="offset != null and limit == null">
            LIMIT #{offset}, 18446744073709551615
        </if>
    </select>

</mapper>
